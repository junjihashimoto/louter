name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  build-and-test:
    name: Build and Test
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest]
        ghc: ['9.6']
        cabal: ['3.10']

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Haskell
      uses: haskell-actions/setup@v2
      with:
        ghc-version: ${{ matrix.ghc }}
        cabal-version: ${{ matrix.cabal }}

    - name: Cache dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.cabal/packages
          ~/.cabal/store
          dist-newstyle
        key: ${{ runner.os }}-ghc-${{ matrix.ghc }}-cabal-${{ hashFiles('**/*.cabal', '**/cabal.project') }}
        restore-keys: |
          ${{ runner.os }}-ghc-${{ matrix.ghc }}-

    - name: Update cabal package list
      run: cabal update

    - name: Build dependencies
      run: cabal build --only-dependencies all

    - name: Build
      run: cabal build all

    - name: Run tests
      run: cabal test all --test-show-details=direct

    - name: Build documentation
      run: cabal haddock all

  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: [build-and-test]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install Python dependencies
      run: |
        pip install openai anthropic google-generativeai pytest

    - name: Setup Haskell
      uses: haskell-actions/setup@v2
      with:
        ghc-version: '9.6'
        cabal-version: '3.10'

    - name: Cache dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.cabal/packages
          ~/.cabal/store
          dist-newstyle
        key: ${{ runner.os }}-ghc-9.6-cabal-${{ hashFiles('**/*.cabal', '**/cabal.project') }}

    - name: Build louter
      run: |
        cabal update
        cabal build all

    - name: Start louter proxy
      run: |
        # Start proxy in background
        cabal exec louter-server -- --config examples/local-llama-server.yaml --port 9000 &
        LOUTER_PID=$!
        echo "LOUTER_PID=$LOUTER_PID" >> $GITHUB_ENV

        # Wait for proxy to be ready
        timeout 30 bash -c 'until curl -s http://localhost:9000/health > /dev/null; do sleep 1; done'
        echo "âœ… Louter proxy is ready"

    - name: Run Python SDK tests
      run: |
        cd tests
        python run_all_tests.py --verbose || true
      env:
        OPENAI_BASE_URL: http://localhost:9000
        OPENAI_API_KEY: test-key
        OPENAI_MODEL: gpt-4

    - name: Stop louter proxy
      if: always()
      run: kill $LOUTER_PID || true
