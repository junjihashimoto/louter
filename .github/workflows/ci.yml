name: CI

on:
  push:
    branches: [ master, main, develop ]
  pull_request:
    branches: [ master, main, develop ]

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  test:
    name: Test & Diagnostics
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install Rust toolchain
      uses: dtolnay/rust-toolchain@stable
      with:
        components: rustfmt, clippy

    - name: Cache cargo
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          target
        key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}

    - name: Check formatting
      run: cargo fmt --all -- --check

    - name: Run clippy
      run: cargo clippy --all-targets --all-features -- -D warnings

    - name: Build
      run: cargo build --verbose

    - name: Run unit tests
      run: cargo test --lib --verbose

    - name: Build binaries
      run: |
        cargo build --bin louter
        cargo build --bin mock-server
        cargo build --bin log-parser

    - name: Run diagnostic tests
      run: |
        # Start mock server in background
        cargo run --bin mock-server -- --port 8888 --test-data-dir test-data > /tmp/mock-server.log 2>&1 &
        MOCK_PID=$!
        echo "Mock server PID: $MOCK_PID"
        sleep 3

        # Start louter with mock config
        cargo run --bin louter -- --port 9000 --config examples/config-mock.toml > /tmp/louter.log 2>&1 &
        LOUTER_PID=$!
        echo "Louter PID: $LOUTER_PID"
        sleep 6

        # Run diagnostics and check results
        curl -s http://localhost:9000/api/diagnostics > /tmp/diagnostics.json

        # Verify all tests passed
        GEMINI_PASSED=$(jq '[.frontends.gemini_api.test_results[] | select(.passed == true)] | length' /tmp/diagnostics.json)
        GEMINI_TOTAL=$(jq '.frontends.gemini_api.test_results | length' /tmp/diagnostics.json)
        OPENAI_PASSED=$(jq '[.frontends.openai_api.test_results[] | select(.passed == true)] | length' /tmp/diagnostics.json)
        OPENAI_TOTAL=$(jq '.frontends.openai_api.test_results | length' /tmp/diagnostics.json)

        echo "Gemini API: $GEMINI_PASSED/$GEMINI_TOTAL passed"
        echo "OpenAI API: $OPENAI_PASSED/$OPENAI_TOTAL passed"

        # Check if all tests passed
        if [ "$GEMINI_PASSED" != "$GEMINI_TOTAL" ] || [ "$OPENAI_PASSED" != "$OPENAI_TOTAL" ]; then
          echo "❌ Diagnostic tests failed!"
          jq '.frontends | to_entries[] | .value.test_results[] | select(.passed == false) | {test: .test_name, error: .error}' /tmp/diagnostics.json
          exit 1
        fi

        echo "✅ All diagnostic tests passed!"

        # Cleanup
        kill $LOUTER_PID $MOCK_PID 2>/dev/null || true

    - name: Upload diagnostic results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: diagnostic-results
        path: |
          /tmp/diagnostics.json
          /tmp/mock-server.log
          /tmp/louter.log

  security-audit:
    name: Security Audit
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install Rust toolchain
      uses: dtolnay/rust-toolchain@stable

    - name: Install cargo-audit
      run: cargo install cargo-audit

    - name: Run security audit
      run: cargo audit

  build-release:
    name: Build Release
    runs-on: ubuntu-latest
    needs: [test, security-audit]
    if: startsWith(github.ref, 'refs/tags/v')

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install Rust toolchain
      uses: dtolnay/rust-toolchain@stable

    - name: Build release
      run: cargo build --release --bin louter

    - name: Create release archive
      run: |
        cd target/release
        tar czf ../../louter-linux-amd64.tar.gz louter

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: louter-linux-amd64
        path: louter-linux-amd64.tar.gz

  release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: [build-release]
    if: startsWith(github.ref, 'refs/tags/v')

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Download artifacts
      uses: actions/download-artifact@v4
      with:
        path: ./artifacts

    - name: Create release
      uses: softprops/action-gh-release@v1
      with:
        files: ./artifacts/**/*
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
